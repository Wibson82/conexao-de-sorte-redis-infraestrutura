name: ðŸš€ Deploy Redis Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - 'docker-compose.yml'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  # ATENÃ‡ÃƒO: Confirme se este Ã© o caminho correto no seu servidor de produÃ§Ã£o
  PROJECT_DIR: /root/conexao-redis-infrastructure 

jobs:
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: [self-hosted, hostinger-runner] # Usa o mesmo runner do outro projeto
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Fetch Redis Password from Azure Key Vault
        id: get_redis_password
        uses: azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AZURE_KEYVAULT_NAME }}
          secrets: 'conexao-de-sorte-redis-password' # Nome exato do secret no Key Vault

      - name: Create .env file on server
        run: |
          echo "ðŸ” Creating .env file in ${{ env.PROJECT_DIR }}"
          echo "REDIS_PASSWORD=${{ steps.get_redis_password.outputs.conexao-de-sorte-redis-password }}" > ${{ env.PROJECT_DIR }}/.env
          echo "âœ… .env file created successfully."

      - name: Deploy Redis with Docker Compose
        run: |
          echo "ðŸš€ Deploying Redis using compose file in ${{ env.PROJECT_DIR }}"
          
          # Garante que a rede externa 'conexao-network' existe
          docker network inspect conexao-network >/dev/null 2>&1 || docker network create conexao-network

          # Define o caminho do arquivo compose para evitar ambiguidades
          COMPOSE_FILE=${{ env.PROJECT_DIR }}/docker-compose.yml

          # Pull da imagem mais recente do Redis
          docker compose -f $COMPOSE_FILE pull

          # Inicia o serviÃ§o em modo detached
          docker compose -f $COMPOSE_FILE up -d
          
          echo "âœ… Redis deployment completed."
