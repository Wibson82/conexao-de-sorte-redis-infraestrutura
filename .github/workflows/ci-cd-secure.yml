name: ğŸ”´ Redis Infrastructure - CI/CD Pipeline (SECURE)

on:
  push:
    branches: [ main ]
    paths: ['docker-compose.yml', 'scripts/**', '.github/workflows/**', 'README.md']
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Destino do deploy'
        required: false
        default: 'production'
        type: choice
        options: [production, staging]

# ğŸ”’ CONFIGURAÃ‡ÃƒO SEGURA - BASEADA EM ZOOKEEPER SUCCESS TEMPLATE
# ================================================================================
env:
  SERVICE_NAME: conexao-de-sorte-redis-infraestrutura
  TZ: America/Sao_Paulo

# ğŸ”’ PERMISSÃ•ES MÃNIMAS PARA OIDC
permissions:
  contents: read
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  # ğŸ” VALIDAÃ‡ÃƒO E BUILD SEGURO
  validate-and-build:
    runs-on: [srv649924, self-hosted, Linux, X64, conexao-de-sorte-redis-infraestrutura]
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4.3.0

      - name: ğŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸ“‹ Confirmar consumo mÃ­nimo do Key Vault
        run: |
          echo 'Job de validaÃ§Ã£o nÃ£o consome segredos do Key Vault (apenas validaÃ§Ã£o).'

      - name: ğŸ” Validate Docker Compose
        run: |
          set -euo pipefail
          if [[ ! -f docker-compose.yml ]]; then
            echo "âŒ docker-compose.yml nÃ£o encontrado"
            exit 1
          fi

          # ValidaÃ§Ã£o bÃ¡sica YAML
          docker-compose config >/dev/null
          echo "âœ… Docker Compose syntax vÃ¡lida"

      - name: ğŸ”’ Security Validation
        run: |
          set -euo pipefail

          # Verificar se nÃ£o hÃ¡ hardcoded passwords
          if grep -rE "(password|pass).*[:=][[:space:]]*['\"][^$\{]" docker-compose.yml | grep -v "secrets:" | grep -v "external:"; then
            echo "âŒ Found hardcoded passwords in compose files"
            exit 1
          fi

          # Verificar fallbacks inseguros
          if grep -q "defaultpass\|default.*pass" docker-compose.yml; then
            echo "âŒ Insecure password fallbacks detected"
            exit 1
          fi

          # Verificar se imagens usam tags especÃ­ficas
          if grep -q ":latest" docker-compose.yml; then
            echo "âŒ Uso de tags 'latest' detectado"
            exit 1
          fi

          echo "âœ… ValidaÃ§Ãµes de seguranÃ§a passaram"

  # ğŸš€ DEPLOY SEGURO EM PRODUÃ‡ÃƒO
  deploy-production:
    needs: validate-and-build
    runs-on: [srv649924, self-hosted, Linux, X64, conexao-de-sorte-redis-infraestrutura]
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      id-token: write
    env:
      DOCKER_NETWORK_NAME: conexao-network-swarm
      STACK_NAME: conexao-redis
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4.3.0

      - name: ğŸ” Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Key Vault secrets (Redis)
        id: kv
        uses: azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AZURE_KEYVAULT_NAME }}
          secrets: |
            conexao-de-sorte-redis-password

      - name: Export and validate Redis password
        run: |
          set -euo pipefail
          secret="${{ steps.kv.outputs.conexao-de-sorte-redis-password }}"

          # ğŸ›¡ï¸ FAIL-FAST: Se nÃ£o conseguir buscar secret, falhar deploy
          if [[ -z "$secret" ]]; then
            echo "âŒ CRITICAL: conexao-de-sorte-redis-password nÃ£o encontrado no Key Vault"
            echo "âŒ Deploy abortado para evitar uso de senhas inseguras"
            exit 1
          fi

          # Masking obrigatÃ³rio
          echo "::add-mask::$secret"

          # ValidaÃ§Ã£o de forÃ§a da senha
          if [[ ${#secret} -lt 8 ]]; then
            echo "âŒ ERRO: Redis password muito simples (mÃ­nimo 8 caracteres)"
            exit 1
          fi

          # Export seguro para Docker
          printf 'REDIS_PASSWORD=%s\n' "$secret" >> "$GITHUB_ENV"
          echo "âœ… Redis password validado e configurado"

      - name: ğŸ³ Create Docker Secrets
        run: |
          set -euo pipefail

          echo "ğŸ”‘ Criando Docker Secret para Redis..."

          SECRET_NAME="conexao-de-sorte-redis-password"

          # Remover secret existente se houver
          if docker secret ls --format "{{.Name}}" | grep -q "^${SECRET_NAME}$"; then
            echo "ğŸ”„ Removendo secret existente..."
            docker secret rm "$SECRET_NAME" || true
            sleep 2
          fi

          # Criar secret com senha do Key Vault
          echo "ğŸ“ Criando secret: $SECRET_NAME"
          echo "$REDIS_PASSWORD" | docker secret create "$SECRET_NAME" -
          echo "âœ… Secret criado com sucesso"

      - name: ğŸ”§ Ensure Docker Resources
        run: |
          set -euo pipefail

          echo "ğŸ”§ Verificando recursos Docker..."

          # Verificar volume Redis
          if ! docker volume ls | grep -q "redis_data"; then
            echo "ğŸ“ Criando volume: redis_data"
            docker volume create redis_data
          else
            echo "âœ… Volume redis_data existe"
          fi

          # Verificar rede Swarm
          if ! docker network ls | grep -q "conexao-network-swarm"; then
            echo "ğŸŒ Criando rede: conexao-network-swarm"
            docker network create --driver overlay conexao-network-swarm
          else
            echo "âœ… Rede conexao-network-swarm existe"
          fi

      - name: ğŸ§¹ Cleanup and Deploy
        run: |
          set -euo pipefail

          echo "ğŸ§¹ Preparando deploy limpo..."

          STACK_NAME="conexao-redis"

          # Remover stack existente
          if docker stack ls | grep -q "$STACK_NAME"; then
            echo "ğŸ—‘ï¸ Removendo stack existente: $STACK_NAME"
            docker stack rm "$STACK_NAME"

            # Aguardar remoÃ§Ã£o
            timeout=60
            elapsed=0
            while docker stack ls | grep -q "$STACK_NAME" && [ $elapsed -lt $timeout ]; do
              sleep 3
              elapsed=$((elapsed + 3))
              echo "â³ Aguardando remoÃ§Ã£o... ($elapsed/$timeout segundos)"
            done
          fi

          # Limpar containers Ã³rfÃ£os
          ORPHAN_CONTAINERS=$(docker ps -a --filter "name=redis" -q || true)
          if [[ -n "$ORPHAN_CONTAINERS" ]]; then
            echo "ğŸ§¹ Removendo containers Ã³rfÃ£os Redis..."
            docker rm -f $ORPHAN_CONTAINERS || true
          fi

      - name: ğŸš€ Deploy Redis Infrastructure
        run: |
          set -euo pipefail

          echo "ğŸš€ Iniciando deploy Redis..."

          STACK_NAME="conexao-redis"

          # Deploy da stack
          docker stack deploy -c docker-compose.yml $STACK_NAME

          echo "â³ Aguardando serviÃ§os ficarem prontos..."
          sleep 20

          # Verificar status com retry
          for i in {1..12}; do
            RUNNING=$(docker service ls --filter name="${STACK_NAME}_redis" --format "{{.Replicas}}" | grep -o '^[0-9]*' | head -1 || echo "0")
            TOTAL=$(docker service ls --filter name="${STACK_NAME}_redis" --format "{{.Replicas}}" | grep -o '/[0-9]*' | sed 's/\///' | head -1 || echo "0")

            if [[ $RUNNING -eq $TOTAL && $TOTAL -gt 0 ]]; then
              echo "âœ… Redis service pronto: $RUNNING/$TOTAL"
              break
            fi

            if [[ $i -eq 12 ]]; then
              echo "âš ï¸ Timeout aguardando Redis - verificando status..."
              docker service ls --filter name="${STACK_NAME}_redis"
              break
            fi

            echo "â³ Aguardando Redis... ($RUNNING/$TOTAL) - tentativa $i/12"
            sleep 10
          done

      - name: ğŸ©º Redis Health Check
        run: |
          set -euo pipefail

          echo "ğŸ©º Validando saÃºde do Redis..."

          # Aguardar inicializaÃ§Ã£o completa
          sleep 15

          REDIS_CONTAINER=$(docker ps --filter "name=redis" --format "{{.ID}}" | head -1 || true)

          if [[ -n "$REDIS_CONTAINER" ]]; then
            echo "âœ… Container Redis encontrado: $REDIS_CONTAINER"

            # Teste 1: Verificar processo Redis
            if docker exec "$REDIS_CONTAINER" ps aux | grep -q "[r]edis-server"; then
              echo "âœ… Processo Redis rodando"
            else
              echo "âŒ Processo Redis nÃ£o encontrado"
              exit 1
            fi

            # Teste 2: Verificar porta 6379
            if docker exec "$REDIS_CONTAINER" netstat -tlnp 2>/dev/null | grep -q ":6379"; then
              echo "âœ… Porta 6379 listening"
            else
              echo "âŒ Porta 6379 nÃ£o disponÃ­vel"
              exit 1
            fi

            # Teste 3: Ping com autenticaÃ§Ã£o
            echo "ğŸ” Testando conectividade Redis com auth..."
            if docker exec "$REDIS_CONTAINER" redis-cli --no-auth-warning -a "$REDIS_PASSWORD" ping | grep -q "PONG"; then
              echo "âœ… Redis respondendo a ping com autenticaÃ§Ã£o"
            else
              echo "âŒ Redis nÃ£o responde a ping autenticado"
              exit 1
            fi

            echo "ğŸ‰ Redis health check completo!"

          else
            echo "âŒ Container Redis nÃ£o encontrado"
            exit 1
          fi

      - name: ğŸ“Š Final Status Report
        if: always()
        run: |
          set -euo pipefail

          echo "ğŸ“Š RELATÃ“RIO FINAL REDIS DEPLOY"
          echo "==============================="

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Status: SUCESSO"
            echo "ğŸ‰ Redis Infrastructure deploy seguro concluÃ­do!"
            echo ""
            echo "ğŸ”— Commit: ${{ github.sha }}"
            echo "ğŸ‘¤ Autor: ${{ github.actor }}"
            echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
            echo ""
            echo "ğŸ”’ SeguranÃ§a: Sem fallbacks inseguros"
            echo "ğŸ”‘ AutenticaÃ§Ã£o: Key Vault integrado"
            echo "âœ… Health checks: Todos passaram"
          else
            echo "âŒ Status: FALHA"
            echo "ğŸš¨ Deploy falhou - verificar logs acima"
            echo ""
            echo "ğŸ”§ Para debug:"
            echo "  1. Verificar logs: docker service logs conexao-redis_redis"
            echo "  2. Verificar status: docker stack services conexao-redis"
            echo "  3. Verificar secrets: docker secret ls"
          fi