name: "ğŸ”´ Redis Test Step 2 - Azure + Key Vault"

on:
  workflow_dispatch:

env:
  SERVICE_NAME: redis-infrastructure

permissions:
  contents: read
  id-token: write

jobs:
  test-azure-connection:
    runs-on: [self-hosted, Linux, X64, conexao-de-sorte-redis-infraestrutura]
    timeout-minutes: 8
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.0
        with:
          clean: true
          fetch-depth: 1

      - name: ğŸ” Verificar Azure Secrets
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_KEYVAULT_NAME: ${{ secrets.AZURE_KEYVAULT_NAME }}
        run: |
          echo "ğŸ” Verificando disponibilidade dos secrets Azure..."
          missing=()
          for var in AZURE_CLIENT_ID AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID; do
            if [[ -z "${!var:-}" ]]; then
              missing+=("$var")
            fi
          done
          if (( ${#missing[@]} )); then
            printf 'âŒ GitHub Secrets obrigatÃ³rios ausentes: %s\n' "${missing[*]}"
            exit 1
          fi
          echo "âœ… Todos os secrets Azure necessÃ¡rios estÃ£o configurados"

          if [[ -n "${AZURE_KEYVAULT_NAME:-}" ]]; then
            echo "âœ… AZURE_KEYVAULT_NAME: ${AZURE_KEYVAULT_NAME}"
          else
            echo "âŒ AZURE_KEYVAULT_NAME nÃ£o configurado"
            exit 1
          fi

      - name: ğŸ” Teste Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸ§ª Teste ConexÃ£o Azure
        run: |
          echo "ğŸ” Testando conexÃ£o Azure..."
          echo "ğŸ“ VersÃ£o Azure CLI: $(az --version | head -1)"
          echo "ğŸ“ Conta atual:"
          az account show --output table
          echo "ğŸ“ Subscription:"
          az account list --query "[?state=='Enabled'].{Name:name, SubscriptionId:id}" --output table
          echo "âœ… ConexÃ£o Azure funcionando!"

      - name: ğŸ—ï¸ Teste Key Vault Access
        env:
          AZURE_KEYVAULT_NAME: ${{ secrets.AZURE_KEYVAULT_NAME }}
        run: |
          echo "ğŸ” Testando acesso ao Key Vault..."
          echo "ğŸ“ Key Vault: ${AZURE_KEYVAULT_NAME}"

          # Listar secrets disponÃ­veis
          echo "ğŸ“ Secrets disponÃ­veis no Key Vault:"
          az keyvault secret list --vault-name "${AZURE_KEYVAULT_NAME}" --query "[].name" --output table

          # Verificar se o secret do Redis existe
          echo "ğŸ”‘ Verificando secret especÃ­fico do Redis..."
          if az keyvault secret show --vault-name "${AZURE_KEYVAULT_NAME}" --name "conexao-de-sorte-redis-password" --query "name" -o tsv > /dev/null 2>&1; then
            echo "âœ… Secret 'conexao-de-sorte-redis-password' encontrado"
          else
            echo "âŒ Secret 'conexao-de-sorte-redis-password' nÃ£o encontrado"
            exit 1
          fi

      - name: ğŸ” Teste ObtenÃ§Ã£o do Secret
        env:
          AZURE_KEYVAULT_NAME: ${{ secrets.AZURE_KEYVAULT_NAME }}
        run: |
          echo "ğŸ” Testando obtenÃ§Ã£o do secret Redis..."
          password=$(az keyvault secret show \
            --vault-name "${AZURE_KEYVAULT_NAME}" \
            --name "conexao-de-sorte-redis-password" \
            --query value -o tsv)

          if [[ -z "$password" ]]; then
            echo "âŒ NÃ£o foi possÃ­vel obter o secret"
            exit 1
          fi

          echo "::add-mask::$password"
          echo "âœ… Secret obtido com sucesso (${#password} caracteres)"

          # Validar tamanho mÃ­nimo
          if [[ ${#password} -lt 12 ]]; then
            echo "âŒ Password muito curto (mÃ­nimo 12 caracteres)"
            exit 1
          fi

          echo "âœ… ValidaÃ§Ã£o do secret concluÃ­da com sucesso!"

      - name: âœ… Resumo do Teste
        run: |
          echo "ğŸ“Š Resumo dos testes Step 2:"
          echo "âœ… Runner self-hosted funcionando"
          echo "âœ… Azure OIDC authentication funcionando"
          echo "âœ… Key Vault acessÃ­vel"
          echo "âœ… Secret Redis disponÃ­vel e vÃ¡lido"
          echo "ğŸ‰ Step 2 concluÃ­do com sucesso!"