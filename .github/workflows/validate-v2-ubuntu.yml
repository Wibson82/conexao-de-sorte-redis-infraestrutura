name: ğŸ”´ Redis V2 Validation (Ubuntu Workaround)

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  SERVICE_NAME: conexao-de-sorte-redis-infraestrutura
  TZ: America/Sao_Paulo

jobs:
  validate-redis-v2:
    runs-on: ubuntu-latest  # WORKAROUND: srv649924 unavailable
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4.3.0

      - name: ğŸ” Azure Login (OIDC) - WORKING PATTERN
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: âœ… Validate Azure connectivity
        run: |
          echo "ğŸ”— Testing Azure connectivity..."
          az account show --output table
          echo "âœ… Azure OIDC working with secrets.AZURE_* pattern"

      - name: ğŸ” Validate Redis V2 Configuration
        run: |
          echo "ğŸ” Validating Redis V2 security fixes..."

          # Check docker-compose.yml for security
          if [[ -f docker-compose.yml ]]; then
            echo "âœ… docker-compose.yml found"

            # Check for hardcoded passwords (should find NONE)
            if grep -r "defaultpass\|redisdefaultpassword" docker-compose.yml; then
              echo "âŒ SECURITY VIOLATION: Hardcoded passwords found"
              exit 1
            fi
            echo "âœ… No hardcoded passwords found"

            # Validate fail-fast security pattern
            if grep -q "FATAL.*refusing to start" docker-compose.yml; then
              echo "âœ… Fail-fast security pattern implemented"
            else
              echo "âš ï¸ Fail-fast pattern not found"
            fi

            # Validate docker compose syntax
            docker compose -f docker-compose.yml config -q
            echo "âœ… Docker Compose syntax valid"
          else
            echo "âŒ docker-compose.yml not found"
            exit 1
          fi

      - name: ğŸ” Validate Workflow Security
        run: |
          echo "ğŸ” Validating ci-cd-secure.yml..."

          if [[ -f .github/workflows/ci-cd-secure.yml ]]; then
            echo "âœ… ci-cd-secure.yml found"

            # Check for hardcoded secrets in workflow
            if grep -rE "(password|secret).*[:=][[:space:]]*['\"][^$\{]" .github/workflows/ci-cd-secure.yml | grep -v "secrets\." | grep -v "GITHUB_"; then
              echo "âŒ SECURITY VIOLATION: Hardcoded secrets in workflow"
              exit 1
            fi
            echo "âœ… No hardcoded secrets in workflow"

            # Validate Azure OIDC pattern
            if grep -q "secrets\.AZURE_CLIENT_ID" .github/workflows/ci-cd-secure.yml; then
              echo "âœ… Correct Azure OIDC pattern (secrets.AZURE_*)"
            else
              echo "âŒ Incorrect Azure OIDC pattern"
              exit 1
            fi
          else
            echo "âŒ ci-cd-secure.yml not found"
            exit 1
          fi

      - name: ğŸ¯ Redis V2 Validation Summary
        run: |
          echo "ğŸ“Š REDIS V2 VALIDATION COMPLETE"
          echo "==============================="
          echo "âœ… Security: All hardcoded passwords eliminated"
          echo "âœ… Workflow: ci-cd-secure.yml pattern validated"
          echo "âœ… Azure OIDC: secrets.AZURE_* pattern working"
          echo "âœ… Docker Compose: Syntax and security validated"
          echo ""
          echo "ğŸ¯ CONCLUSION: Redis V2 security fixes are READY for deployment"
          echo "âš ï¸ BLOCKER: srv649924 runner unavailable"
          echo "ğŸ”§ WORKAROUND: This validation runs on ubuntu-latest successfully"