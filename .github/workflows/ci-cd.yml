name: ğŸ”´ Redis Infrastructure - CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths: ['docker-compose.yml', 'scripts/**', '.github/workflows/**', 'README.md']
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Destino do deploy'
        required: false
        default: 'production'
        type: choice
        options: [production, staging]

env:
  SERVICE_NAME: conexao-de-sorte-redis-infraestrutura
  TZ: America/Sao_Paulo

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    name: âœ… Validate Configuration
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate docker-compose.yml
        run: |
          if [ -f docker-compose.yml ]; then
            echo "âœ… docker-compose.yml exists"
            docker-compose config -q
            echo "âœ… docker-compose.yml is valid"
          else
            echo "âŒ docker-compose.yml not found"
            exit 1
          fi
          
      - name: Validate environment template
        run: |
          if [ -f .env.example ]; then
            echo "âœ… .env.example exists"
          else
            echo "âš ï¸ .env.example not found - creating template"
            cat > .env.example << 'EOF'
          # Redis Infrastructure Configuration
          REDIS_PASSWORD=your-secure-redis-password-here
          EOF
          fi
          
      - name: Security scan
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          if grep -r "password.*=" . --exclude-dir=.git --exclude-dir=node_modules; then
            echo "âš ï¸ Found potential hardcoded passwords - review required"
          else
            echo "âœ… No hardcoded passwords found"
          fi
          
      - name: Validate Redis configuration
        run: |
          echo "ğŸ” Validating Redis configuration..."
          if grep -q "requirepass" docker-compose.yml; then
            echo "âœ… Password protection enabled"
          else
            echo "âŒ Redis password protection not configured"
            exit 1
          fi
          
          if grep -q "appendonly yes" docker-compose.yml; then
            echo "âœ… Redis persistence (AOF) enabled"
          else
            echo "âš ï¸ Redis persistence not explicitly configured"
          fi

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy Redis Infrastructure
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }
            
      - name: Load Redis secrets
        uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ secrets.AZURE_KEYVAULT_NAME }}
          secrets: |
            REDIS-PASSWORD
        id: redis-secrets
        
      - name: Create production .env
        run: |
          echo "REDIS_PASSWORD=${{ steps.redis-secrets.outputs.REDIS-PASSWORD }}" > .env
          echo "âœ… Environment file created with secure password"
          
      - name: Deploy Redis
        run: |
          echo "ğŸ”´ Deploying Redis Infrastructure..."
          echo "Password configured from Azure Key Vault"
          
          # Verificar se rede existe
          if ! docker network inspect conexao-network > /dev/null 2>&1; then
            echo "ğŸ”§ Creating conexao-network..."
            docker network create conexao-network
          fi
          
          # Deploy Redis
          docker-compose up -d
          
          # Aguardar Redis inicializar
          echo "â³ Waiting for Redis to be ready..."
          sleep 15
          
      - name: Health check
        run: |
          echo "ğŸ” Performing Redis health check..."
          
          # Verificar se container estÃ¡ rodando
          if docker ps | grep -q conexao-redis; then
            echo "âœ… Redis container is running"
          else
            echo "âŒ Redis container is not running"
            docker-compose logs
            exit 1
          fi
          
          # Verificar conectividade
          if docker exec conexao-redis redis-cli -a "${{ steps.redis-secrets.outputs.REDIS-PASSWORD }}" ping | grep -q "PONG"; then
            echo "âœ… Redis responding to ping"
          else
            echo "âŒ Redis not responding"
            exit 1
          fi
          
          # Verificar persistÃªncia
          docker exec conexao-redis redis-cli -a "${{ steps.redis-secrets.outputs.REDIS-PASSWORD }}" BGREWRITEAOF
          echo "âœ… Redis AOF rewrite triggered"
          
      - name: Test Redis functionality
        run: |
          echo "ğŸ§ª Testing Redis functionality..."
          
          # Teste bÃ¡sico de set/get
          docker exec conexao-redis redis-cli -a "${{ steps.redis-secrets.outputs.REDIS-PASSWORD }}" SET test-key "deployment-test"
          
          if docker exec conexao-redis redis-cli -a "${{ steps.redis-secrets.outputs.REDIS-PASSWORD }}" GET test-key | grep -q "deployment-test"; then
            echo "âœ… Redis SET/GET working"
          else
            echo "âŒ Redis SET/GET failed"
            exit 1
          fi
          
          # Limpar teste
          docker exec conexao-redis redis-cli -a "${{ steps.redis-secrets.outputs.REDIS-PASSWORD }}" DEL test-key
          
      - name: Update documentation
        run: |
          echo "ğŸ“ Updating deployment status..."
          echo "Last deployed: $(date)" >> deployment-history.md
          echo "Commit: ${{ github.sha }}" >> deployment-history.md
          echo "âœ… Redis Infrastructure successfully deployed"
          
      - name: Notify deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Redis Infrastructure deployment successful"
            echo "ğŸ”— Redis available at: conexao-redis:6379"
            echo "ğŸ” Monitor with: docker logs -f conexao-redis"
          else
            echo "âŒ Redis Infrastructure deployment failed"
            docker-compose logs
          fi
      - name: Print runner host
        run: |
          echo "Host: $(hostname)"
          uname -a
      - name: Check GitHub API
        run: curl -s https://api.github.com/rate_limit | head -n 5