name: üî¥ Redis Infrastructure - CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths: ['docker-compose.yml', 'scripts/**', '.github/workflows/**', 'README.md']
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Destino do deploy'
        required: false
        default: 'production'
        type: choice
        options: [production, staging]

# ----------------------------------------------------------------------
# PAR√ÇMETROS GERAIS
# ----------------------------------------------------------------------

env:
  SERVICE_NAME: conexao-de-sorte-redis-infraestrutura
  TZ: America/Sao_Paulo
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_KEYVAULT_NAME: ${{ secrets.AZURE_KEYVAULT_NAME }}

# Configura√ß√£o de permiss√µes para GitHub OIDC
permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash -euo pipefail {0}

# ----------------------------------------------------------------------
# JOB 1 ‚ñ∏ VALIDA√á√ÉO (GITHUB-HOSTED) - IGUAL AO TRAEFIK
# ----------------------------------------------------------------------

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    name: üîç Validate & Build
    timeout-minutes: 10
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üîç Validate docker-compose files
        timeout-minutes: 3
        run: |
          # Valida√ß√£o simples de sintaxe YAML (sem Docker)
          echo "üîç Validando sintaxe YAML do docker-compose.yml..."

          # Verificar se arquivo existe
          if [[ ! -f docker-compose.yml ]]; then
            echo "‚ùå Arquivo docker-compose.yml n√£o encontrado"
            exit 1
          fi

          # Valida√ß√£o b√°sica de sintaxe YAML usando Python
          python3 -c "
          import yaml
          import sys
          try:
              with open('docker-compose.yml', 'r') as f:
                  yaml.safe_load(f)
              print('‚úÖ YAML syntax is valid')
          except yaml.YAMLError as e:
              print(f'‚ùå YAML syntax error: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'‚ùå Error reading file: {e}')
              sys.exit(1)
          "

          # Verifica√ß√µes b√°sicas de estrutura
          echo "üîç Verificando estrutura b√°sica..."

          if grep -q "services:" docker-compose.yml; then
            echo "‚úÖ Se√ß√£o 'services' encontrada"
          else
            echo "‚ùå Se√ß√£o 'services' n√£o encontrada"
            exit 1
          fi

          if grep -q "redis:" docker-compose.yml; then
            echo "‚úÖ Servi√ßo 'redis' encontrado"
          else
            echo "‚ùå Servi√ßo 'redis' n√£o encontrado"
            exit 1
          fi

          echo "‚úÖ Valida√ß√£o simplificada conclu√≠da com sucesso"

      - name: üß™ Basic Structure Validation
        timeout-minutes: 1
        run: |
          echo "üîç Verificando estrutura de servi√ßos..."

          # Verificar se servi√ßo redis est√° definido
          if grep -A 5 "^  redis:" docker-compose.yml | grep -q "image:"; then
            echo "‚úÖ Servi√ßo Redis com imagem definida"
          else
            echo "‚ùå Servi√ßo Redis mal configurado"
            exit 1
          fi

          # Verificar se secrets est√£o definidos
          if grep -q "secrets:" docker-compose.yml; then
            echo "‚úÖ Se√ß√£o secrets encontrada"
          else
            echo "‚ùå Se√ß√£o secrets n√£o encontrada"
            exit 1
          fi

          echo "‚úÖ Estrutura b√°sica validada"

      - name: üõ°Ô∏è Security Scan
        timeout-minutes: 3
        run: |
          if [ -f docker-compose.yml ]; then
            # Verificar se n√£o h√° secrets hardcoded
            if grep -r "password.*:" docker-compose.yml | grep -v "\${" | grep -v "#" | grep -v "file:" | grep -v "external:" | grep -E "password:[[:space:]]*[^[:space:]\$]"; then
              echo "‚ùå Found hardcoded passwords in compose files"
              exit 1
            else
              echo "‚úÖ No hardcoded passwords found"
            fi

            # Verificar se imagens usam tags espec√≠ficas (evitar latest)
            if grep -q ":latest" docker-compose.yml; then
              echo "‚ùå Uso de tags 'latest' detectado - n√£o recomendado para produ√ß√£o"
              exit 1
            else
              echo "‚úÖ Todas as imagens usam tags espec√≠ficas"
            fi
          else
            echo "‚ùå docker-compose.yml n√£o encontrado"
            exit 1
          fi

# ----------------------------------------------------------------------
# JOB 2 ‚ñ∏ DEPLOY (SELF-HOSTED) - IGUAL AO TRAEFIK
# ----------------------------------------------------------------------

  deploy-production:
    needs: validate-and-build
    runs-on: [self-hosted, Linux, X64, conexao-de-sorte-redis-infraestrutura]
    name: üöÄ Deploy to Production
    timeout-minutes: 25
    if: github.ref == 'refs/heads/main'
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üîê Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: üîë Load Redis Secrets from Azure Key Vault
        run: |
          echo "üîê Carregando secrets do Redis do Azure Key Vault..."

          # Secrets existentes no Azure Key Vault
          REDIS_PASSWORD=$(az keyvault secret show --name "conexao-de-sorte-redis-password" --vault-name "${{ env.AZURE_KEYVAULT_NAME }}" --query "value" -o tsv)
          REDIS_DATABASE=$(az keyvault secret show --name "conexao-de-sorte-redis-database" --vault-name "${{ env.AZURE_KEYVAULT_NAME }}" --query "value" -o tsv)

          # Configura√ß√µes fixas para Redis (n√£o s√£o secrets)
          REDIS_HOST="redis"  # Nome do servi√ßo Docker
          REDIS_PORT="6379"   # Porta padr√£o Redis

          # Mascarar apenas secrets reais nos logs para seguran√ßa
          echo "::add-mask::$REDIS_PASSWORD"
          echo "::add-mask::$REDIS_DATABASE"

          # Adicionar ao ambiente sem expor nos logs
          echo "REDIS_PASSWORD=$REDIS_PASSWORD" >> $GITHUB_ENV
          echo "REDIS_HOST=$REDIS_HOST" >> $GITHUB_ENV
          echo "REDIS_PORT=$REDIS_PORT" >> $GITHUB_ENV
          echo "REDIS_DATABASE=$REDIS_DATABASE" >> $GITHUB_ENV
          echo "‚úÖ Redis secrets carregados do Azure Key Vault (password, database)"
          echo "‚úÖ Redis configura√ß√µes definidas (host: $REDIS_HOST, port: $REDIS_PORT)"

      - name: üîê Create Docker Secrets (Production)
        timeout-minutes: 5
        run: |
          echo "üîê Criando Docker Secrets para produ√ß√£o..."

          # Criar secret do Redis no Docker Swarm
          echo "$REDIS_PASSWORD" | docker secret create conexao-de-sorte-redis-password - 2>/dev/null || {
            echo "‚ÑπÔ∏è Secret conexao-de-sorte-redis-password j√° existe, removendo e recriando..."
            docker secret rm conexao-de-sorte-redis-password 2>/dev/null || true
            echo "$REDIS_PASSWORD" | docker secret create conexao-de-sorte-redis-password -
          }

          echo "‚úÖ Docker Secrets criados com sucesso para produ√ß√£o"

      - name: üîç Validate Docker Secrets (Production)
        timeout-minutes: 3
        run: |
          echo "üîç Validando Docker Secrets criados..."

          # Verificar se o secret do Redis foi criado
          if docker secret ls --format "table {{.Name}}" | grep -q "conexao-de-sorte-redis-password"; then
            echo "‚úÖ Secret conexao-de-sorte-redis-password encontrado"
          else
            echo "‚ùå Secret conexao-de-sorte-redis-password n√£o encontrado"
            exit 1
          fi

          echo "‚úÖ Valida√ß√£o de secrets conclu√≠da com sucesso"

      - name: üöÄ Deploy Redis Production Stack
        timeout-minutes: 15
        run: |
          set -euo pipefail
          STACK_NAME="conexao-redis"

          echo "üöÄ Iniciando deploy do Redis Stack para PRODU√á√ÉO..."
          echo "üì¶ Stack: $STACK_NAME"
          echo "üìÅ Compose: docker-compose.yml"

          # Verificar se arquivo existe
          if [[ ! -f docker-compose.yml ]]; then
            echo "‚ùå Arquivo docker-compose.yml n√£o encontrado"
            exit 1
          fi

          # Deploy da stack
          echo "üîÑ Executando deploy da stack de produ√ß√£o..."
          docker stack deploy -c docker-compose.yml "$STACK_NAME"

          echo "‚úÖ Stack de produ√ß√£o deployada com sucesso"

          # Aguardar servi√ßos ficarem prontos
          echo "‚è≥ Aguardando servi√ßos de produ√ß√£o ficarem prontos..."
          timeout 180 bash -c "
            while true; do
              RUNNING=\$(docker stack services $STACK_NAME --format 'table {{.Replicas}}' | grep -v REPLICAS | grep -c '1/1' || echo '0')
              TOTAL=\$(docker stack services $STACK_NAME --format 'table {{.Name}}' | grep -v NAME | wc -l)

              echo \"  Servi√ßos prontos: \$RUNNING/\$TOTAL\"

              if [[ \$RUNNING -eq \$TOTAL && \$TOTAL -gt 0 ]]; then
                echo '‚úÖ Todos os servi√ßos de produ√ß√£o est√£o prontos'
                break
              fi

              sleep 15
            done
          " || {
            echo "‚ö†Ô∏è Timeout aguardando servi√ßos de produ√ß√£o - verificando status..."
            docker stack services "$STACK_NAME"
          }

          echo "üéâ Deploy do Redis PRODU√á√ÉO conclu√≠do com sucesso!"

      - name: üîç Health Check Redis Production
        timeout-minutes: 5
        run: |
          echo "üîç Executando health check do Redis em produ√ß√£o..."

          # Aguardar um pouco mais para garantir que o Redis est√° completamente inicializado
          sleep 30

          # Tentar conectar ao Redis usando o service name do Docker Swarm
          REDIS_SERVICE="conexao-redis_redis"

          # Verificar se o servi√ßo est√° rodando
          if docker service ls | grep -q "$REDIS_SERVICE"; then
            echo "‚úÖ Servi√ßo Redis encontrado: $REDIS_SERVICE"

            # Tentar executar um ping no Redis
            if docker service logs "$REDIS_SERVICE" --tail 10 | grep -q "Ready to accept connections"; then
              echo "‚úÖ Redis est√° aceitando conex√µes"
            else
              echo "‚ö†Ô∏è Redis pode ainda estar inicializando - verificando logs..."
              docker service logs "$REDIS_SERVICE" --tail 20
            fi
          else
            echo "‚ùå Servi√ßo Redis n√£o encontrado"
            echo "Servi√ßos dispon√≠veis:"
            docker service ls
            exit 1
          fi

          echo "‚úÖ Health check do Redis conclu√≠do"

      - name: üìä Production Status Summary
        if: always()
        run: |
          echo "üìä RESUMO DO DEPLOY DE PRODU√á√ÉO - REDIS INFRASTRUCTURE"
          echo "============================================================"
          echo "üïí Timestamp: $(date)"
          echo "üì¶ Stack: conexao-redis"
          echo "üîó Commit: ${{ github.sha }}"
          echo "üë§ Autor: ${{ github.actor }}"
          echo ""

          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ STATUS: DEPLOY REALIZADO COM SUCESSO"
            echo ""
            echo "üî¥ Redis Infrastructure est√° rodando em produ√ß√£o"
            echo "üåê Dispon√≠vel na rede: conexao-network-swarm"
            echo "üîç Monitoramento: docker service logs conexao-redis_redis -f"
            echo ""
            echo "üìã Pr√≥ximos passos:"
            echo "  1. Verificar logs: docker service logs conexao-redis_redis"
            echo "  2. Monitorar performance"
            echo "  3. Validar conectividade com outros servi√ßos"
          else
            echo "‚ùå STATUS: FALHA NO DEPLOY"
            echo ""
            echo "üîß Para debug:"
            echo "  1. Verificar logs: docker service logs conexao-redis_redis"
            echo "  2. Verificar status: docker stack services conexao-redis"
            echo "  3. Verificar secrets: docker secret ls"
          fi