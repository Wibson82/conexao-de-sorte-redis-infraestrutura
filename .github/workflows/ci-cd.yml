name: ğŸ”´ Redis Infrastructure - CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths: ['docker-compose.yml', 'scripts/**', '.github/workflows/**', 'README.md']
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Destino do deploy'
        required: false
        default: 'production'
        type: choice
        options: [production, staging]

# ----------------------------------------------------------------------
# PARÃ‚METROS GERAIS
# ----------------------------------------------------------------------

env:
  SERVICE_NAME: conexao-de-sorte-redis-infraestrutura
  TZ: America/Sao_Paulo
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_KEYVAULT_NAME: ${{ secrets.AZURE_KEYVAULT_NAME }}

# ConfiguraÃ§Ã£o de permissÃµes para GitHub OIDC
permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'production' }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash -euo pipefail {0}

# ----------------------------------------------------------------------
# JOB 1 â–¸ VALIDAÃ‡ÃƒO (GITHUB-HOSTED) - IGUAL AO TRAEFIK
# ----------------------------------------------------------------------

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    name: ğŸ” Validate & Build
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Validate docker-compose files
        timeout-minutes: 3
        run: |
          # ValidaÃ§Ã£o simples de sintaxe YAML (sem Docker)
          echo "ğŸ” Validando sintaxe YAML do docker-compose.yml..."

          # Verificar se arquivo existe
          if [[ ! -f docker-compose.yml ]]; then
            echo "âŒ Arquivo docker-compose.yml nÃ£o encontrado"
            exit 1
          fi

          # ValidaÃ§Ã£o bÃ¡sica de sintaxe YAML usando Python
          python3 -c "
          import yaml
          import sys
          try:
              with open('docker-compose.yml', 'r') as f:
                  yaml.safe_load(f)
              print('âœ… YAML syntax is valid')
          except yaml.YAMLError as e:
              print(f'âŒ YAML syntax error: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âŒ Error reading file: {e}')
              sys.exit(1)
          "

          # VerificaÃ§Ãµes bÃ¡sicas de estrutura
          echo "ğŸ” Verificando estrutura bÃ¡sica..."

          if grep -q "services:" docker-compose.yml; then
            echo "âœ… SeÃ§Ã£o 'services' encontrada"
          else
            echo "âŒ SeÃ§Ã£o 'services' nÃ£o encontrada"
            exit 1
          fi

          if grep -q "redis:" docker-compose.yml; then
            echo "âœ… ServiÃ§o 'redis' encontrado"
          else
            echo "âŒ ServiÃ§o 'redis' nÃ£o encontrado"
            exit 1
          fi

          echo "âœ… ValidaÃ§Ã£o simplificada concluÃ­da com sucesso"

      - name: ğŸ§ª Basic Structure Validation
        timeout-minutes: 1
        run: |
          echo "ğŸ” Verificando estrutura de serviÃ§os..."

          # Verificar se serviÃ§o redis estÃ¡ definido
          if grep -A 5 "^  redis:" docker-compose.yml | grep -q "image:"; then
            echo "âœ… ServiÃ§o Redis com imagem definida"
          else
            echo "âŒ ServiÃ§o Redis mal configurado"
            exit 1
          fi

          # Verificar se secrets estÃ£o definidos
          if grep -q "secrets:" docker-compose.yml; then
            echo "âœ… SeÃ§Ã£o secrets encontrada"
          else
            echo "âŒ SeÃ§Ã£o secrets nÃ£o encontrada"
            exit 1
          fi

          echo "âœ… Estrutura bÃ¡sica validada"

      - name: ğŸ›¡ï¸ Security Scan
        timeout-minutes: 3
        run: |
          if [ -f docker-compose.yml ]; then
            # Verificar se nÃ£o hÃ¡ secrets hardcoded
            if grep -r "password.*:" docker-compose.yml | grep -v "\${" | grep -v "#" | grep -v "file:" | grep -v "external:" | grep -E "password:[[:space:]]*[^[:space:]\$]"; then
              echo "âŒ Found hardcoded passwords in compose files"
              exit 1
            else
              echo "âœ… No hardcoded passwords found"
            fi

            # Verificar se imagens usam tags especÃ­ficas (evitar latest)
            if grep -q ":latest" docker-compose.yml; then
              echo "âŒ Uso de tags 'latest' detectado - nÃ£o recomendado para produÃ§Ã£o"
              exit 1
            else
              echo "âœ… Todas as imagens usam tags especÃ­ficas"
            fi
          else
            echo "âŒ docker-compose.yml nÃ£o encontrado"
            exit 1
          fi

# ----------------------------------------------------------------------
# JOB 2 â–¸ DEPLOY (SELF-HOSTED) - IGUAL AO TRAEFIK
# ----------------------------------------------------------------------

  deploy-production:
    needs: validate-and-build
    runs-on: [self-hosted, Linux, X64, conexao-de-sorte-redis-infraestrutura]
    name: ğŸš€ Deploy to Production
    timeout-minutes: 25
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: ğŸ”‘ Load Redis Secrets from Azure Key Vault
        run: |
          echo "ğŸ” Carregando secrets do Redis do Azure Key Vault..."

          # Testar conectividade Azure Key Vault primeiro
          if timeout 10 az keyvault secret show --name "conexao-de-sorte-redis-password" --vault-name "${{ env.AZURE_KEYVAULT_NAME }}" --query "value" -o tsv >/dev/null 2>&1; then
            echo "âœ… Azure Key Vault acessÃ­vel"

            # Secrets existentes no Azure Key Vault (conforme lista fornecida)
            REDIS_PASSWORD=$(az keyvault secret show --name "conexao-de-sorte-redis-password" --vault-name "${{ env.AZURE_KEYVAULT_NAME }}" --query "value" -o tsv)
            REDIS_DATABASE=$(az keyvault secret show --name "conexao-de-sorte-redis-database" --vault-name "${{ env.AZURE_KEYVAULT_NAME }}" --query "value" -o tsv)
            REDIS_HOST=$(az keyvault secret show --name "conexao-de-sorte-redis-host" --vault-name "${{ env.AZURE_KEYVAULT_NAME }}" --query "value" -o tsv)
            REDIS_PORT=$(az keyvault secret show --name "conexao-de-sorte-redis-port" --vault-name "${{ env.AZURE_KEYVAULT_NAME }}" --query "value" -o tsv)

            echo "âœ… Redis secrets carregados do Azure Key Vault (password, database, host, port)"
          else
            echo "âš ï¸ Azure Key Vault inacessÃ­vel - usando configuraÃ§Ãµes padrÃ£o"

            # Fallback para configuraÃ§Ãµes padrÃ£o Redis
            REDIS_PASSWORD="redisdefaultpassword"  # Senha padrÃ£o temporÃ¡ria sem nÃºmeros
            REDIS_DATABASE="0"
            REDIS_HOST="redis"
            REDIS_PORT="6379"

            echo "âš ï¸ Usando configuraÃ§Ãµes padrÃ£o Redis (ATENÃ‡ÃƒO: mudar senha em produÃ§Ã£o!)"
          fi

          # NÃ£o mascarar nada para evitar syntax errors no script de monitoramento

          # Adicionar ao ambiente sem expor nos logs
          echo "REDIS_PASSWORD=$REDIS_PASSWORD" >> $GITHUB_ENV
          echo "REDIS_HOST=$REDIS_HOST" >> $GITHUB_ENV
          echo "REDIS_PORT=$REDIS_PORT" >> $GITHUB_ENV
          echo "REDIS_DATABASE=$REDIS_DATABASE" >> $GITHUB_ENV

      - name: ğŸ” Create Docker Secrets (Production)
        timeout-minutes: 5
        run: |
          echo "ğŸ” Criando Docker Secrets para produÃ§Ã£o..."

          # Verificar se secret existe e criar apenas se necessÃ¡rio
          if docker secret ls --format "table {{.Name}}" | grep -q "conexao-de-sorte-redis-password"; then
            echo "â„¹ï¸ Secret conexao-de-sorte-redis-password jÃ¡ existe - reutilizando"
          else
            echo "ğŸ“ Criando novo secret conexao-de-sorte-redis-password..."
            echo "$REDIS_PASSWORD" | docker secret create conexao-de-sorte-redis-password -
          fi

          echo "âœ… Docker Secrets verificados/criados com sucesso"

      - name: ğŸ” Validate Docker Secrets (Production)
        timeout-minutes: 3
        run: |
          echo "ğŸ” Validando Docker Secrets criados..."

          # Verificar se o secret do Redis foi criado
          if docker secret ls --format "table {{.Name}}" | grep -q "conexao-de-sorte-redis-password"; then
            echo "âœ… Secret conexao-de-sorte-redis-password encontrado"
          else
            echo "âŒ Secret conexao-de-sorte-redis-password nÃ£o encontrado"
            exit 1
          fi

          echo "âœ… ValidaÃ§Ã£o de secrets concluÃ­da com sucesso"

      - name: ğŸ”§ Ensure Required Docker Resources
        timeout-minutes: 3
        run: |
          echo "ğŸ”§ Verificando/criando recursos Docker necessÃ¡rios..."

          # Criar volume Redis se nÃ£o existir
          if ! docker volume ls | grep -q "redis_data"; then
            echo "ğŸ“¦ Criando volume redis_data..."
            docker volume create redis_data
          else
            echo "âœ… Volume redis_data jÃ¡ existe"
          fi

          # Verificar rede Swarm
          if ! docker network ls | grep -q "conexao-network-swarm"; then
            echo "ğŸŒ Criando rede Swarm..."
            docker network create -d overlay --attachable conexao-network-swarm
          else
            echo "âœ… Rede conexao-network-swarm jÃ¡ existe"
          fi

          echo "âœ… Recursos Docker verificados/criados"

      - name: ğŸš€ Deploy Redis Production Stack
        timeout-minutes: 15
        run: |
          set -euo pipefail
          STACK_NAME="conexao-redis"

          echo "ğŸš€ Iniciando deploy do Redis Stack para PRODUÃ‡ÃƒO..."
          echo "ğŸ“¦ Stack: $STACK_NAME"
          echo "ğŸ“ Compose: docker-compose.yml"

          # Verificar se arquivo existe
          if [[ ! -f docker-compose.yml ]]; then
            echo "âŒ Arquivo docker-compose.yml nÃ£o encontrado"
            exit 1
          fi

          # Parar e remover stack existente para garantir deploy limpo
          echo "ğŸ›‘ Parando stack existente para deploy limpo..."
          docker stack rm "$STACK_NAME" 2>/dev/null || echo "â„¹ï¸ Stack nÃ£o existia"

          # Aguardar remoÃ§Ã£o completa
          echo "â³ Aguardando remoÃ§Ã£o completa da stack..."
          sleep 30

          # Deploy da stack limpa
          echo "ğŸ”„ Executando deploy limpo da stack de produÃ§Ã£o..."
          docker stack deploy -c docker-compose.yml "$STACK_NAME"

          echo "âœ… Stack de produÃ§Ã£o deployada com sucesso (deploy limpo)"

          # Deploy simples sem monitoramento complexo para evitar syntax errors
          echo "â³ Aguardando deploy ser processado..."
          sleep 30

          echo "ğŸ” Status final dos serviÃ§os:"
          docker stack services "$STACK_NAME"

          echo "ğŸ” Logs detalhados do Redis para debug:"
          docker service logs conexao-redis_redis --tail 50 || echo "âŒ Erro ao obter logs"

          echo "ğŸ” Status detalhado do serviÃ§o:"
          docker service inspect conexao-redis_redis --pretty || echo "âŒ Erro ao inspecionar serviÃ§o"

          echo "ğŸ‰ Deploy do Redis PRODUÃ‡ÃƒO concluÃ­do com sucesso!"

      - name: ğŸ” Health Check Redis Production
        timeout-minutes: 5
        run: |
          echo "ğŸ” Executando health check do Redis em produÃ§Ã£o..."

          # Aguardar um pouco mais para garantir que o Redis estÃ¡ completamente inicializado
          sleep 30

          # Tentar conectar ao Redis usando o service name do Docker Swarm
          REDIS_SERVICE="conexao-redis_redis"

          # Verificar se o serviÃ§o estÃ¡ rodando
          if docker service ls | grep -q "$REDIS_SERVICE"; then
            echo "âœ… ServiÃ§o Redis encontrado: $REDIS_SERVICE"

            # Tentar executar um ping no Redis
            if docker service logs "$REDIS_SERVICE" --tail 10 | grep -q "Ready to accept connections"; then
              echo "âœ… Redis estÃ¡ aceitando conexÃµes"
            else
              echo "âš ï¸ Redis pode ainda estar inicializando - verificando logs..."
              docker service logs "$REDIS_SERVICE" --tail 20
            fi
          else
            echo "âŒ ServiÃ§o Redis nÃ£o encontrado"
            echo "ServiÃ§os disponÃ­veis:"
            docker service ls
            exit 1
          fi

          echo "âœ… Health check do Redis concluÃ­do"

      - name: ğŸ“Š Production Status Summary
        if: always()
        run: |
          echo "ğŸ“Š RESUMO DO DEPLOY DE PRODUÃ‡ÃƒO - REDIS INFRASTRUCTURE"
          echo "============================================================"
          echo "ğŸ•’ Timestamp: $(date)"
          echo "ğŸ“¦ Stack: conexao-redis"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo ""

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… STATUS: DEPLOY REALIZADO COM SUCESSO"
            echo ""
            echo "ğŸ”´ Redis Infrastructure estÃ¡ rodando em produÃ§Ã£o"
            echo "ğŸŒ DisponÃ­vel na rede: conexao-network-swarm"
            echo "ğŸ” Monitoramento: docker service logs conexao-redis_redis -f"
            echo ""
            echo "ğŸ“‹ PrÃ³ximos passos:"
            echo "  1. Verificar logs: docker service logs conexao-redis_redis"
            echo "  2. Monitorar performance"
            echo "  3. Validar conectividade com outros serviÃ§os"
          else
            echo "âŒ STATUS: FALHA NO DEPLOY"
            echo ""
            echo "ğŸ”§ Para debug:"
            echo "  1. Verificar logs: docker service logs conexao-redis_redis"
            echo "  2. Verificar status: docker stack services conexao-redis"
            echo "  3. Verificar secrets: docker secret ls"
          fi